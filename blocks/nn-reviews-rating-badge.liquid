{% doc %}
  NN Reviews Rating Badge Block

  A compact rating display showing stars, rating value, and review count.
  Uses closest.product or block.settings.product for data source.

  @example
  Add this block to display a product's average rating
{% enddoc %}

{% liquid
  assign target_product = block.settings.product | default: closest.product | default: product
  # App-owned metafields - use resolved namespace for regular themes
  assign rating = target_product.metafields['app--294319325185--reviews'].rating.value
  assign count = target_product.metafields['app--294319325185--reviews'].rating_count.value

  # Build suffix text with product name placeholder
  assign suffix_text = block.settings.suffix
  if suffix_text != blank and suffix_text contains '{{product.title}}'
    assign suffix_text = suffix_text | replace: '{{product.title}}', target_product.title
  endif

  # Typography logic from text.liquid
  assign text_width = block.settings.width

  if block.settings.font_size contains 'heading-lg' or block.settings.font_size contains 'heading-xl'
    assign type = 'display'
  elsif block.settings.font_size contains 'heading'
    assign type = 'heading'
  else
    assign type = 'body'
  endif

  capture text_block_classes
    if text_width == '100%'
      echo 'text-block--align-' | append: block.settings.alignment
      if block.settings.max_width == 'none'
        echo ' text-block--full-width '
      endif
    endif
    if block.settings.type_preset == 'custom'
      echo ' custom-typography '
      if block.settings.font_size != ''
        echo ' custom-font-size '
      endif
      if block.settings.color != ''
        echo ' custom-color '
      endif
    endif
  endcapture
%}

<span
  class="nn-reviews-rating-badge text-block {{ block.settings.type_preset }} {{ text_block_classes }}"
  style="
    {% render 'typography-style', settings: block.settings %}
    --width: {{ text_width }};
    --max-width: var(--max-width--{{ type }}-{{ block.settings.max_width }});
    {% if text_width == '100%' %}
      --text-align: {{ block.settings.alignment }};
    {% endif %}
    --star-color: {{ block.settings.star_color }};
  "
  {{ block.shopify_attributes }}
>
  {%- render 'nn-reviews-rating-badge',
    rating: rating,
    count: count,
    star_color: block.settings.star_color,
    show_stars: block.settings.show_stars,
    show_rating_value: block.settings.show_rating_value,
    show_count: block.settings.show_count,
    hide_when_empty: block.settings.hide_when_empty,
    suffix: suffix_text
  -%}
</span>

{% stylesheet %}
  .nn-reviews-rating-stars {
    display: inline;
    white-space: nowrap;
  }

  .nn-reviews-rating-stars__star {
    display: inline;
    line-height: 1;
  }

  .nn-reviews-rating-stars__star--filled {
    color: var(--star-color, #ffc107);
  }

  .nn-reviews-rating-stars__star--partial {
    position: relative;
  }

  .nn-reviews-rating-stars__star--partial::before {
    content: 'â˜…';
    position: absolute;
    left: 0;
    top: 0;
    color: var(--star-color, #ffc107);
    clip-path: inset(0 calc(100% - var(--fill-percent, 50%)) 0 0);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "NN Reviews Rating Badge",
  "tag": null,
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Leave empty to use the current product context"
    },
    {
      "type": "checkbox",
      "id": "hide_when_empty",
      "label": "Hide when no reviews",
      "default": false,
      "info": "When disabled, shows empty stars for products without reviews"
    },
    {
      "type": "checkbox",
      "id": "show_stars",
      "label": "Show stars",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating_value",
      "label": "Show rating value",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_count",
      "label": "Show review count",
      "default": true
    },
    {
      "type": "text",
      "id": "suffix",
      "label": "Suffix text",
      "info": "Text to display after the rating. Use {{product.title}} for the product name.",
      "placeholder": "for {{ closest.product.title }}"
    },
    {
      "type": "color",
      "id": "star_color",
      "label": "Star color",
      "default": "#ffc107"
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit"
        },
        {
          "value": "100%",
          "label": "t:options.fill"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "select",
      "id": "max_width",
      "label": "t:settings.max_width",
      "options": [
        {
          "value": "narrow",
          "label": "t:options.narrow"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "none",
          "label": "t:options.none"
        }
      ],
      "default": "none"
    },
    {
      "type": "text_alignment",
      "id": "alignment",
      "label": "t:settings.alignment",
      "default": "left",
      "visible_if": "{{ block.settings.width == '100%' }}"
    },
    {
      "type": "header",
      "content": "t:content.typography"
    },
    {
      "type": "select",
      "id": "type_preset",
      "label": "t:settings.preset",
      "options": [
        {
          "value": "paragraph",
          "label": "t:options.paragraph"
        },
        {
          "value": "h1",
          "label": "t:options.h1"
        },
        {
          "value": "h2",
          "label": "t:options.h2"
        },
        {
          "value": "h3",
          "label": "t:options.h3"
        },
        {
          "value": "h4",
          "label": "t:options.h4"
        },
        {
          "value": "h5",
          "label": "t:options.h5"
        },
        {
          "value": "h6",
          "label": "t:options.h6"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "paragraph",
      "info": "t:info.edit_presets_in_theme_settings"
    },
    {
      "type": "select",
      "id": "font",
      "label": "t:settings.font",
      "options": [
        {
          "value": "var(--font-body--family)",
          "label": "t:options.body"
        },
        {
          "value": "var(--font-subheading--family)",
          "label": "t:options.subheading"
        },
        {
          "value": "var(--font-heading--family)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--font-accent--family)",
          "label": "t:options.accent"
        }
      ],
      "default": "var(--font-body--family)",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "font_size",
      "label": "t:settings.size",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "0.625rem",
          "label": "10px"
        },
        {
          "value": "0.75rem",
          "label": "12px"
        },
        {
          "value": "0.875rem",
          "label": "14px"
        },
        {
          "value": "1rem",
          "label": "16px"
        },
        {
          "value": "1.125rem",
          "label": "18px"
        },
        {
          "value": "1.25rem",
          "label": "20px"
        },
        {
          "value": "1.5rem",
          "label": "24px"
        },
        {
          "value": "2rem",
          "label": "32px"
        },
        {
          "value": "2.5rem",
          "label": "40px"
        },
        {
          "value": "3rem",
          "label": "48px"
        },
        {
          "value": "3.5rem",
          "label": "56px"
        },
        {
          "value": "4.5rem",
          "label": "72px"
        },
        {
          "value": "5.5rem",
          "label": "88px"
        },
        {
          "value": "7.5rem",
          "label": "120px"
        },
        {
          "value": "9.5rem",
          "label": "152px"
        },
        {
          "value": "11.5rem",
          "label": "184px"
        }
      ],
      "default": "1rem",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "line_height",
      "label": "t:settings.line_height",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "letter_spacing",
      "label": "t:settings.letter_spacing",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "case",
      "label": "t:settings.case",
      "options": [
        {
          "value": "none",
          "label": "t:options.default"
        },
        {
          "value": "uppercase",
          "label": "t:options.uppercase"
        }
      ],
      "default": "none",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "wrap",
      "label": "t:settings.wrap",
      "options": [
        {
          "value": "pretty",
          "label": "t:options.pretty"
        },
        {
          "value": "balance",
          "label": "t:options.balance"
        },
        {
          "value": "nowrap",
          "label": "t:options.none"
        }
      ],
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "color",
      "label": "t:settings.color",
      "options": [
        {
          "value": "var(--color-foreground)",
          "label": "t:options.text"
        },
        {
          "value": "var(--color-foreground-heading)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--color-primary)",
          "label": "t:options.link"
        }
      ],
      "default": "var(--color-foreground)"
    }
  ],
  "presets": [
    {
      "name": "NN Reviews Rating Badge",
      "category": "NN Review"
    }
  ]
}
{% endschema %}
