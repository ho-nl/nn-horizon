{% doc %}
  NN Review Rating Block

  Displays star rating for a review using SVG stars with fractional support.
  Uses closest.metaobject.nn_reviews to access review data.

  @example
  Add this block inside a review card or any context with nn_reviews metaobject
{% enddoc %}

{% liquid
  assign block_settings = block.settings
  assign review = closest.metaobject.nn_reviews
  assign rating = review.rating.value | times: 1
  assign scale_max = block_settings.scale_max | default: 5

  # Calculate star fill levels
  assign rating_floor = rating | floor
  assign decimal = rating | modulo: 1
  assign decimal_rating = 0

  if decimal >= 0.3 and decimal <= 0.7
    assign decimal_rating = 0.5
  elsif decimal > 0.7
    assign decimal_rating = 1
  endif

  assign decimal_rounded = decimal_rating | ceil
  assign svg_filled_stars = rating_floor | plus: decimal_rounded

  assign text_width = block_settings.width

  if block_settings.font_size contains 'heading-lg' or block_settings.font_size contains 'heading-xl'
    assign type = 'display'
  elsif block_settings.font_size contains 'heading'
    assign type = 'heading'
  else
    assign type = 'body'
  endif

  capture text_block_classes
    if text_width == '100%'
      echo 'text-block--align-' | append: block_settings.alignment
      if block_settings.max_width == 'none'
        echo ' text-block--full-width '
      endif
    endif
    if block_settings.type_preset == 'custom'
      echo ' custom-typography '
      if block_settings.font_size != ''
        echo ' custom-font-size '
      endif
      if block_settings.color != ''
        echo ' custom-color '
      endif
    endif
  endcapture
%}

{% if rating != blank %}
  <div
    class="nn-review-rating rating-color--{{ block_settings.rating_color }} text-block {{ block_settings.type_preset }} {{ text_block_classes }}"
    style="
      {% render 'typography-style', settings: block_settings %}
      --width: {{ text_width }};
      --max-width: var(--max-width--{{ type }}-{{ block_settings.max_width }});
      {% if text_width == '100%' %}
        --text-align: {{ block_settings.alignment }};
      {% endif %}
    "
    {{ block.shopify_attributes }}
  >
    <svg
      class="visually-hidden"
      style="width: 0; height: 0;"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 32 32"
      role="presentation"
    >
      <defs>
        <linearGradient id="nn-half-{{ block.id }}" x1="0" x2="100%" y1="0" y2="0">
          <stop offset="50%" stop-color="var(--star-fill-color)"></stop>
          <stop offset="50%" stop-color="{% if block_settings.stars_style == 'outline' %}transparent{% else %}rgb(var(--star-fill-color-rgb) / var(--opacity-20)){% endif %}"></stop>
        </linearGradient>

        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" id="nn-star-{{ block.id }}">
          <path d="M31.547 12a.848.848 0 00-.677-.577l-9.427-1.376-4.224-8.532a.847.847 0 00-1.516 0l-4.218 8.534-9.427 1.355a.847.847 0 00-.467 1.467l6.823 6.664-1.612 9.375a.847.847 0 001.23.893l8.428-4.434 8.432 4.432a.847.847 0 001.229-.894l-1.615-9.373 6.822-6.665a.845.845 0 00.214-.869z" />
        </symbol>
      </defs>
    </svg>

    <span
      class="nn-review-rating__stars"
      style="--star-size: 1.1em;"
      aria-label="{{ 'accessibility.rating' | t: rating: rating }}"
    >
      {% if block_settings.stars_style == 'single' %}
        <svg
          class="nn-review-rating__star {% if svg_filled_stars > 0 %}nn-review-rating__star--filled{% endif %}"
          viewBox="0 0 32 32"
          style="--empty-star-fill-color: rgb(var(--star-fill-color-rgb) / var(--opacity-20))"
          role="presentation"
        >
          <use xlink:href="#nn-star-{{ block.id }}"></use>
        </svg>
      {% else %}
        {%- for star in (1..scale_max) -%}
          <svg
            class="nn-review-rating__star {% if star <= svg_filled_stars %}nn-review-rating__star--filled{% endif %}"
            viewBox="0 0 32 32"
            style="--empty-star-fill-color: {% if block_settings.stars_style == 'outline' %}transparent{% else %}rgb(var(--star-fill-color-rgb) / var(--opacity-20)){% endif %}"
            role="presentation"
          >
            <use xlink:href="#nn-star-{{ block.id }}"{% if decimal_rating == 0.5 and star == svg_filled_stars %} fill="url(#nn-half-{{ block.id }})"{% endif %}></use>
            {% if block_settings.stars_style == 'outline' %}
              <use xlink:href="#nn-star-{{ block.id }}" fill="none" stroke="var(--star-fill-color)" stroke-width="var(--icon-stroke-width, 2)"></use>
            {% endif %}
          </svg>
        {%- endfor -%}
      {% endif %}
    </span>

    {% if block_settings.show_number %}
      <span class="nn-review-rating__number">
        {% if block_settings.stars_style == 'single' %}
          <span aria-hidden="true">{{ rating | round: 1 }}</span>
        {% endif %}
      </span>
    {% endif %}
  </div>
{% endif %}

{% stylesheet %}
  .nn-review-rating {
    display: inline;
    min-width: fit-content;
  }

  .rating-color--primary {
    --star-fill-color: var(--color-primary);
    --star-fill-color-rgb: var(--color-primary-rgb);
  }

  .rating-color--foreground {
    --star-fill-color: var(--color-foreground);
    --star-fill-color-rgb: var(--color-foreground-rgb);
  }

  .rating-color--gold {
    --star-fill-color: #ffc107;
    --star-fill-color-rgb: 255 193 7;
  }

  .nn-review-rating__stars {
    display: inline;
    white-space: nowrap;
  }

  .nn-review-rating__star {
    display: inline-block;
    height: var(--star-size, 1rem);
    width: var(--star-size, 1rem);
    fill: var(--empty-star-fill-color);
    vertical-align: -0.125em;
  }

  .nn-review-rating__star--filled {
    fill: var(--star-fill-color);
  }

  .nn-review-rating__number {
    color: var(--star-fill-color);
    white-space: nowrap;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "NN Review Rating",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "Displays the star rating from a review metaobject. Add inside a NN Review Card or context with nn_reviews."
    },
    {
      "type": "select",
      "id": "stars_style",
      "label": "Style",
      "options": [
        { "value": "outline", "label": "Outline" },
        { "value": "shaded", "label": "Shaded" },
        { "value": "single", "label": "Single" }
      ],
      "default": "shaded"
    },
    {
      "type": "checkbox",
      "id": "show_number",
      "label": "Show rating number",
      "default": false
    },
    {
      "type": "range",
      "id": "scale_max",
      "label": "Maximum stars",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5
    },
    {
      "type": "select",
      "id": "rating_color",
      "label": "Star color",
      "options": [
        { "value": "foreground", "label": "Text" },
        { "value": "primary", "label": "Link" },
        { "value": "gold", "label": "Gold" }
      ],
      "default": "gold"
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "width",
      "label": "t:settings.width",
      "options": [
        { "value": "fit-content", "label": "t:options.fit" },
        { "value": "100%", "label": "t:options.fill" }
      ],
      "default": "fit-content"
    },
    {
      "type": "select",
      "id": "max_width",
      "label": "t:settings.max_width",
      "options": [
        { "value": "narrow", "label": "t:options.narrow" },
        { "value": "normal", "label": "t:options.normal" },
        { "value": "none", "label": "t:options.none" }
      ],
      "default": "normal"
    },
    {
      "type": "text_alignment",
      "id": "alignment",
      "label": "t:settings.alignment",
      "default": "left",
      "visible_if": "{{ block.settings.width == '100%' }}"
    },
    {
      "type": "header",
      "content": "t:content.typography"
    },
    {
      "type": "select",
      "id": "type_preset",
      "label": "t:settings.preset",
      "options": [
        { "value": "paragraph", "label": "t:options.paragraph" },
        { "value": "h1", "label": "t:options.h1" },
        { "value": "h2", "label": "t:options.h2" },
        { "value": "h3", "label": "t:options.h3" },
        { "value": "h4", "label": "t:options.h4" },
        { "value": "h5", "label": "t:options.h5" },
        { "value": "h6", "label": "t:options.h6" },
        { "value": "custom", "label": "t:options.custom" }
      ],
      "default": "paragraph",
      "info": "t:info.edit_presets_in_theme_settings"
    },
    {
      "type": "select",
      "id": "font",
      "label": "t:settings.font",
      "options": [
        { "value": "var(--font-body--family)", "label": "t:options.body" },
        { "value": "var(--font-subheading--family)", "label": "t:options.subheading" },
        { "value": "var(--font-heading--family)", "label": "t:options.heading" },
        { "value": "var(--font-accent--family)", "label": "t:options.accent" }
      ],
      "default": "var(--font-body--family)",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "font_size",
      "label": "t:settings.size",
      "options": [
        { "value": "", "label": "t:options.default" },
        { "value": "0.625rem", "label": "10px" },
        { "value": "0.75rem", "label": "12px" },
        { "value": "0.875rem", "label": "14px" },
        { "value": "1rem", "label": "16px" },
        { "value": "1.125rem", "label": "18px" },
        { "value": "1.25rem", "label": "20px" },
        { "value": "1.5rem", "label": "24px" },
        { "value": "2rem", "label": "32px" },
        { "value": "2.5rem", "label": "40px" },
        { "value": "3rem", "label": "48px" },
        { "value": "3.5rem", "label": "56px" },
        { "value": "4.5rem", "label": "72px" },
        { "value": "5.5rem", "label": "88px" },
        { "value": "7.5rem", "label": "120px" },
        { "value": "9.5rem", "label": "152px" },
        { "value": "11.5rem", "label": "184px" }
      ],
      "default": "1rem",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "line_height",
      "label": "t:settings.line_height",
      "options": [
        { "value": "tight", "label": "t:options.tight" },
        { "value": "normal", "label": "t:options.normal" },
        { "value": "loose", "label": "t:options.loose" }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "letter_spacing",
      "label": "t:settings.letter_spacing",
      "options": [
        { "value": "tight", "label": "t:options.tight" },
        { "value": "normal", "label": "t:options.normal" },
        { "value": "loose", "label": "t:options.loose" }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "case",
      "label": "t:settings.case",
      "options": [
        { "value": "none", "label": "t:options.default" },
        { "value": "uppercase", "label": "t:options.uppercase" }
      ],
      "default": "none",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "wrap",
      "label": "t:settings.wrap",
      "options": [
        { "value": "pretty", "label": "t:options.pretty" },
        { "value": "balance", "label": "t:options.balance" },
        { "value": "nowrap", "label": "t:options.none" }
      ],
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "color",
      "label": "t:settings.color",
      "options": [
        { "value": "var(--color-foreground)", "label": "t:options.text" },
        { "value": "var(--color-foreground-heading)", "label": "t:options.heading" },
        { "value": "var(--color-primary)", "label": "t:options.link" }
      ],
      "default": "var(--color-foreground)"
    }
  ],
  "presets": [
    {
      "name": "NN Review Rating",
      "category": "NN Review"
    }
  ]
}
{% endschema %}
