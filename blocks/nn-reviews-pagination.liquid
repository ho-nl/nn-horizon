{% doc %}
  NN Reviews Pagination Block

  Displays pagination controls for reviews using the theme's pagination styling.

  @example
  Add this block to enable pagination for reviews
{% enddoc %}

{% liquid
  assign review_product = block.settings.product | default: closest.product | default: product
  # App-owned metafields - use resolved namespace for regular themes
  assign all_reviews = review_product.metafields['app--294319325185--reviews'].list.value

  # Parse URL parameters
  assign review_page = 1
  assign review_sort = ''

  if request.path contains '/nn_reviews_sort='
    assign sort_parts = request.path | split: '/nn_reviews_sort='
    assign sort_value = sort_parts[1] | split: '&' | first | split: '#' | first
    assign review_sort = sort_value

    if request.path contains '&nn_reviews_page='
      assign page_parts = request.path | split: '&nn_reviews_page='
      assign page_value = page_parts[1] | split: '&' | first | split: '#' | first
      assign review_page = page_value | plus: 0
      if review_page < 1
        assign review_page = 1
      endif
    endif
  elsif request.path contains '/nn_reviews_page='
    assign page_parts = request.path | split: '/nn_reviews_page='
    assign page_value = page_parts[1] | split: '/' | first | split: '#' | first
    assign review_page = page_value | plus: 0
    if review_page < 1
      assign review_page = 1
    endif
  endif

  # Determine active sort order
  assign active_sort = 'newest'
  if review_sort != ''
    assign active_sort = review_sort
  endif

  # Get reviews per page from settings
  assign reviews_per_page = block.settings.reviews_per_page | default: 10
  assign current_page = review_page

  # Count reviews using size filter (for loops are limited to 50 iterations)
  assign total_reviews = all_reviews | size

  assign total_pages = total_reviews | divided_by: reviews_per_page
  assign remainder = total_reviews | modulo: reviews_per_page
  if remainder > 0
    assign total_pages = total_pages | plus: 1
  endif

  assign base_url = review_product.url
  assign scroll_target = block.settings.scroll_target | default: 'nn-reviews'
%}

<div {{ block.shopify_attributes }}>
  {% render 'nn-reviews-pagination-controls',
    current_page: current_page,
    total_pages: total_pages,
    base_url: base_url,
    active_sort: active_sort,
    scroll_target: scroll_target
  %}
</div>

{% schema %}
{
  "name": "NN Reviews Pagination",
  "tag": null,
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Leave empty to use the current product context"
    },
    {
      "type": "range",
      "id": "reviews_per_page",
      "min": 1,
      "max": 50,
      "step": 1,
      "label": "Reviews per page",
      "default": 10,
      "info": "Must match the setting in the NN Reviews List section"
    },
    {
      "type": "text",
      "id": "scroll_target",
      "label": "Scroll target ID",
      "default": "nn-reviews",
      "info": "The element ID to scroll to when navigating pages"
    }
  ],
  "presets": [
    {
      "name": "NN Reviews Pagination",
      "category": "NN Review"
    }
  ]
}
{% endschema %}
